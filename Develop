import glob
import numpy as np
from matplotlib import pyplot as plt
from skimage import io
from io import BytesIO
from PIL import Image
import PIL, requests
import skimage
from skimage.filters.rank import entropy
from skimage.morphology import disk

def step_1(matrix_1, matrix_color, msuma_matrix):
    for m in range(matrix_1.shape[0]):
        for n in range(matrix_1.shape[0]):
            if (msuma_matrix[m,n] != 0):
                matrix_1[m,n] = (3*matrix_color[m,n])/msuma_matrix[m,n]
            else:
                matrix_1[m,n] = msuma_matrix[m,n]
    return matrix_1

def step_2(matrix_1, matrix_2, matrix_image_pan):
    for m in range(matrix_2.shape[0]):
        for n in range(matrix_2.shape[0]):
            matrix_2[m,n] = matrix_1[m,n]*matrix_image_pan[m,n]
    return matrix_2

def step_3(matrix_1):
    mat_max = np.amax(matrix_1)
    mat_min = np.amin(matrix_1)
    return mat_max, mat_min

def step_4(matrix_1, matrix_color, mat_max, mat_min):
    for m in range(matrix_color.shape[0]):
        for n in range(matrix_color.shape[0]):
            matrix_color[m,n] = (((matrix_1[m,n]-mat_min)*255)/(mat_max-mat_min))
    return matrix_color


im_pan = skimage.io.imread('pan8r.tif', plugin='tifffile')
#p1 = im_pan.astype(np.float32)


im_multi = skimage.io.imread('rgb81r.tif', plugin='tifffile')
plt.imshow(im_multi)

b_red = im_multi[:,:,0]
red_float = b_red.astype(np.float32)
b_green = im_multi[:,:,1]
green_float = b_green.astype(np.float32)
b_blue = im_multi[:,:,2]
blue_float = b_blue.astype(np.float32)
pan_float = im_pan.astype(np.float32)
msuma = red_float+green_float+blue_float
ceros_red = np.zeros_like(red_float)
red_step1 = step_1(ceros_red, red_float, msuma)
ceros_green = np.zeros_like(green_float)
green_step1 = step_2(red_step1, ceros_green, pan_float)
ceros_blue = np.zeros_like(blue_float)
blue_step1 = ceros_blue
blue_step1 = step_1(blue_step1, blue_float, msuma)
blue_step2 = ceros_blue
blue_step2 = step_2(blue_step1, blue_step2, pan_float)
ceros2_green = np.zeros_like(green_float)
ceros2_green = step_1(ceros2_green, green_float, msuma)
ceros3_green = np.zeros_like(green_float)
ceros3_green = step_2(ceros2_green, ceros3_green, pan_float)
Amax, Amin = step_3(green_step1)
ceros2_red = np.zeros_like(red_float)
ceros2_red = step_4(green_step1, ceros2_red, Amax, Amin)
Amax, Amin = step_3(ceros3_green)
gg = np.zeros_like(green_float)
gg = step_4(ceros3_green, gg, Amax, Amin)
Amax, Amin = step_3(blue_step2)
bb = np.zeros_like(blue_float)
bb = step_4(blue_step2, bb, Amax, Amin)
rrr = ceros2_red.astype(np.uint8)
ggg = gg.astype(np.uint8)
bbb = bb.astype(np.uint8)

# Combina las bandas resultantes
fusioned_image = np.stack((rrr, ggg, bbb),axis=2)
t = skimage.io.imsave('broveycpu_image.tif',fusioned_image, plugin='tifffile')



